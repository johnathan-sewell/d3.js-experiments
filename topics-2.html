<!--
bugs to solve:
  - intersect of topics of same size and bias reports false positives
  - improve efficiency of collision detection
-->
<!DOCTYPE html>
<html>
  <head>
  </head>
  <body style="background-color:#eee;margin:10px">
    <style>
      span{
        position: absolute;
        display: block;
      }
      #segmentA{
        position: absolute;
        left:62px;
        top: 492px;
        color: hsl(337, 62%, 51%);
        font-size: 22px;
      }
      #segmentB{
        position: absolute;
        right:62px;
        top: 492px;
        color: hsl(195, 100%, 39%);
        font-size: 22px;
      }
    </style>
    <div id='container' style="width:1200px; height:540px; background-color:#fff;position:relative">
<!--       <svg>
        <line x1="600" y1="0"
              x2="600" y2="540"
              stroke="#666"
              stroke-width="2"/>
        <line x1="300" y1="0"
              x2="300" y2="540"
              stroke="#666"
              stroke-width="2"/>
        <line x1="900" y1="0"
              x2="900" y2="540"
              stroke="#666"
              stroke-width="2"/>
      </svg> -->
      <div style="background:linear-gradient(45deg, hsl(337, 62%, 51%), hsl(195, 100%, 39%));height:10px;position:relative;bottom:-520px;width:90%;margin:0 auto"></div>
      <span id="segmentA">Technology</span>
      <span id="segmentB">Food & Drinks</span>
    </div>


    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="http://underscorejs.org/underscore-min.js" charset="utf-8"></script>

    <script type="text/javascript">

var data = [
  {name: 'Caramel Apple', bias: 1.00, volume: 21},
  {name: 'apple cider', bias: 0.79, volume: 29},
  {name: 'apple juice', bias: 0.77, volume: 26},
  {name: 'Apple Cake', bias: 0.71, volume: 14},
  {name: 'apple pie', bias: 0.62, volume: 42},
  {name: 'Jony Ive ', bias:-0.40, volume: 10},
  {name: 'Apple\'s', bias:-0.53, volume: 80},
  {name: 'Mac Pro', bias:-0.60, volume: 15},
  {name: 'Mavericks', bias:-0.60, volume: 35},
  {name: 'iPad Air ', bias:-0.63, volume: 27},
  {name: 'iOS 7', bias:-0.65, volume: 17},
  {name: 'Apple\'s new', bias:-0.75, volume: 16},
  {name: 'OS X Mavericks ', bias:-0.75, volume: 16},
  {name: 'Business ', bias:-0.85, volume: 13},
  {name: 'Apple MacBook Pro', bias:-0.95, volume: 39},
];

var containerWidth = 1200,
    containerHeight = 540;

var color = d3.scale.linear()
    .domain([-1, 1])
    .range(["hsl(337, 62%, 51%)", "hsl(195, 100%, 39%)"])
    .interpolate(d3.interpolateHsl);

var xScale = d3.scale.linear()
    .domain([-1, 1])
    .range([300, 900]); /*use less than the width of the container - HACK to prevent text elements being cut off*/

var container = d3.select('#container');

var textElements = container.selectAll('span.topic')
    .data(data);

var takenBoxes = [];

function isBoxInContainer(box) {
  var result = box.x1 >= 0 && box.y1 <= containerHeight;
  return result;
};

function isSpaceAvailable(box) {
  var isAvailable;

  if (!this.isBoxInContainer(box)){
    return false;
  }

  return (takenBoxes).every(function(takenBox) {
    //check for overlap
    // http://stackoverflow.com/questions/306316/determine-if-two-rectangles-overlap-each-other
    // http://silentmatt.com/rectangle-intersection/

    //A's left edge is to the right of B's right edge
    //A's right edge is to the left of the B's left edge
    var noHorizontalIntersect = (box.x1 > takenBox.x2 || box.x2 < takenBox.x1)

    //A's top edge is below B's bottom  edge
    //A's bottom edge is above B's top edge
    var noVerticalIntersect = (box.y1 > takenBox.y2 || box.y2 < takenBox.y1);

    return noVerticalIntersect || noHorizontalIntersect;
  });
};

function findPositionForWord(label, x, y, width, height) {

  var yRange,
    found = false,
    testbox;

  testbox = {
    x1: x,
    y1: y,
    x2: x + width,
    y2: y + height
  };

  yRange = _.range(0, containerHeight-height, 10); //step could be used to speedup layout calculations

  var centralYPositions =yRange.slice(Math.floor(.33 * yRange.length), Math.floor(.66 * yRange.length));
  found = isPositionAvailable(centralYPositions, testbox, width, height);

  if(!found){
    var outerYPositions = yRange.slice(0, Math.floor(.33 * yRange.length)).concat(yRange.slice(Math.floor(.66 * yRange.length), yRange.length));
    found = isPositionAvailable(outerYPositions, testbox, width, height);
  }

  if(!found){
    console.warn('could not find space for word ' + label);
  }
  console.log('placing ' + label + ' at ' + JSON.stringify(testbox));
  return testbox;
}

//iterate the Y positions randomly and try to place the word
function isPositionAvailable(yRange, testbox, width, height) {
  while (yRange.length > 0) {
    var randomIndex,
      candidateY;

    randomIndex = Math.floor(Math.random() * yRange.length),
    candidateY = yRange.splice(randomIndex, 1)[0]

    testbox.y1 = candidateY;
    testbox.y2 = candidateY + height;

    //debug box
    // d3.select('#container')
    //   .append('div')
    //   .style('left', testbox.x1 + 'px')
    //   .style('top', testbox.y1 + 'px')
    //   .style('position', 'absolute')
    //   .style('width', width + 'px')
    //   .style('height', height + 'px')
    //   .style('border', '1px solid #000');

    if (isSpaceAvailable(testbox)) {
      takenBoxes.push(testbox);
      return true;
    }
  }
  return false;
}

// initial placement
//-------------------
textElements
  .enter()
  .append('span')
  .attr('class', 'topic')
  .text(function(d) { return d.name; })   //elements seem to be added to the page as soon as you set attributes
  .style('color', function(d){ return color(d.bias);})
  .style('font-size', function(d){return d.volume + 'px';})
  .style('left', function(d) {
    d.x = xScale(d.bias) - (this.clientWidth * .5); /*shift to left by .5 clientwidth to center*/
    return d.x + 'px';
  })
  .style('top', function(d) {
    d.y = Math.floor(Math.random() * (containerHeight - this.clientHeight)); //initial y position is random
    return d.y + 'px';
  });

// layout
//--------
textElements
  .sort(function(a, b) {
      return b.volume - a.volume;
  })
  .each(function(d) {
    d.width = this.clientWidth;
    d.height = this.clientHeight;

    var position = findPositionForWord(d.name, d.x, d.y, d.width, d.height);
    d3.select(this).style('top', position.y1 + 'px');
  });

    </script>
  </body>
</html>