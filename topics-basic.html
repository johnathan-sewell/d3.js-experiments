<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8 />
</head>
<body style="font-family:sans-serif">

    <svg width="970" height="540">
        <text x="20" y="520"
            font-family="sans-serif"
            font-size="18",
            style="fill:#333">
            Topics favoured by female authors
        </text>
        <text x="680" y="520"
            font-family="sans-serif"
            font-size="18",
            style="fill:#333">
            Topics favoured by male authors
        </text>
    </svg>
    <form>
        <input type="checkbox" name="showAll" id="showAll">
        <label for="showAll">Show common topics</label>
    </form>

    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>

    <script>

        var data = [{
            topic: 'NOITOUR',
            groupA: 0,
            groupB: 10
        }, {
            topic: 'Singing',
            groupA: 2,
            groupB: 18
        }, {
            topic: 'Love Will Remember',
            groupA: 2,
            groupB: 16
        }, {
            topic: 'Barclays advert',
            groupA: 1,
            groupB: 6
        }, {
            topic: 'LightningBoltTour',
            groupA: 2,
            groupB: 11
        }, {
            topic: 'Barclays Open Innovation',
            groupA: 1,
            groupB: 5
        }, {
            topic: 'Drake',
            groupA: 4,
            groupB: 18
        }, {
            topic: 'Win',
            groupA: 5,
            groupB: 11
        }, {
            topic: 'Barclays Bank',
            groupA: 7,
            groupB: 13
        }, {
            topic: 'Barclays Center',
            groupA: 238,
            groupB: 293
        }, {
            topic: 'Brooklyn NY',
            groupA: 12,
            groupB: 14
        }, {
            topic: 'Barclays league',
            groupA: 2,
            groupB: 2
        }, {
            topic: 'Retired to the rafters',
            groupA: 3,
            groupB: 3
        }, {
            topic: 'Jason Kidds',
            groupA: 5,
            groupB: 5
        }, {
            topic: 'Pearl Jams',
            groupA: 5,
            groupB: 5
        }, {
            topic: 'Player of the Month',
            groupA: 18,
            groupB: 16
        }, {
            topic: 'Pearl Jam at Barclays',
            groupA: 9,
            groupB: 7
        }, {
            topic: 'Brooklyn Nets',
            groupA: 7,
            groupB: 5
        }, {
            topic: 'LFC',
            groupA: 149,
            groupB: 104
        }, {
            topic: 'Norwich City',
            groupA: 6,
            groupB: 4
        }, {
            topic: 'Libor Lowballing',
            groupA: 6,
            groupB: 2
        }, {
            topic: 'Open practice',
            groupA: 6,
            groupB: 2
        }, {
            topic: 'Hawthorns',
            groupA: 9,
            groupB: 3
        }, {
            topic: 'Congratulations',
            groupA: 13,
            groupB: 4
        }, {
            topic: 'Premier League matches',
            groupA: 8,
            groupB: 2
        }, {
            topic: 'Setlist',
            groupA: 8,
            groupB: 2
        }, {
            topic: 'Nets jersey',
            groupA: 10,
            groupB: 1
        }, {
            topic: 'Barclays UK',
            groupA: 15,
            groupB: 1
        }, {
            topic: 'Barclays Premier League table',
            groupA: 5,
            groupB: 0
        }, {
            topic: 'Concert tickets',
            groupA: 7,
            groupB: 0
        }]

        var settings = {
            inputDomain: [0, d3.max(data, function(d) { return d.groupA + d.groupB; })],
            outputRange: [40, 100],
            minRadius: 16, // minimum collision radius
            maxRadius: 65, // also determines collision search radius
            collisionPadding: 4
        };
        var svg = d3.select('body').select('svg')
            .style('border', '1px solid #ccc');

        var scale = d3.scale.linear()
            .domain(settings.inputDomain) //input domain
            .range(settings.outputRange);    //output range

        // var scale = d3.scale.sqrt()
        //     .domain([0, d3.max(data.topics, function(d) { return d.count; })])
        //     .range([0, maxRadius]);

        var fontScale = d3.scale.linear()
            .domain(settings.inputDomain) //input domain
            .range([12, 30]);    //output range

        data.forEach(function(d, i) {
            d.id = i;
            d.radius = scale(d.groupA + d.groupB);
            d.proportion = fraction(d.groupA, d.groupB);
            d.bias = .5 - Math.max(.1, Math.min(.9, d.proportion));
        });

        var force = d3.layout.force()
            .nodes(data)
            .charge(1)
            .size([970, 540])
            .on("tick", tick)
            .start();

        var circleAnchors = svg.selectAll(".circle-anchor")
            .data(data)
                .enter()
                    .append('a')
                    .attr('class', 'circle-anchor');

        var groupA = circleAnchors.append("g")
            .attr("class", "g-groupA");

        groupA.append("clipPath")
            .attr("id", function(d) { return "g-clip-groupA-" + d.id; })
            .append("rect")
                .attr("y", function(d) { return -d.radius - 4 /*clipping*/; })
                .attr("x", function(d) { return -d.radius - 4 /*clipping*/; })
                .attr("height", function(d) { return 2 * d.radius + 2 * 4 /*clipping*/; })
                .attr("width", function(d) { return 2 * d.radius * d.proportion + 4 /*clipping*/; });

        var circles = groupA.append("circle")
            .attr("clip-path", function(d) { return "url(#g-clip-groupA-" + d.id + ")"; })
            .attr("fill", '#cf3370')
            .attr("r", function(d){ return d.radius;});

        var groupB = circleAnchors.append("g")
            .attr("class", "g-groupB");

        groupB.append("clipPath")
            .attr("id", function(d) { return "g-clip-groupB-" + d.id; })
            .append("rect")
                .attr("y", function(d) { return -d.radius - 4 /*clipping*/; })
                .attr("x", function(d) { return -d.radius + 2 * d.radius * d.proportion; })
                .attr("height", function(d) { return 2 * d.radius + 2 * 4 /*clipping*/; })
                .attr("width", function(d) { return 2 * d.radius; });

        var circles = groupB.append("circle")
            .attr("clip-path", function(d) { return "url(#g-clip-groupB-" + d.id + ")"; })
            .attr("fill", '#0095c8')
            .attr("r", function(d){ return d.radius;});

        var labels = svg.selectAll(".text-node")
            .data(data).
                enter()
                    .append("text")
                    .text(function(d) { return d.topic; })
                    .attr('fill', '#111')
                    .attr('font-family', 'sans-serif')
                    .attr('font-size', function(d){
                        return fontScale(d.groupA + d.groupB);
                    })
                    .each(function(d) {
                        d.labelWidth = this.getBoundingClientRect().width;
                    });

        function tick(e) {
            circleAnchors
                .each(bias(e.alpha * 100))
                .each(collide(.5))
                .attr("transform", function(d) {
                    return "translate(" + d.x + "," + d.y + ")";
                });

            labels
                .attr("x", function(d) {
                    return (d.x - (d.labelWidth / 2)) + "px";
                })
                .attr("y", function(d) {
                    return d.y + "px";
                });
        }

        // function charge(d){
        //     var diameter = d.radius * 2;
        //     return -(diameter * 10);
        // }

        // Given two quantities a and b, returns the fraction to split the circle a + b.
        function fraction(a, b) {
          var k = a / (a + b);
          if (k > 0 && k < 1) {
            var t0, t1 = Math.pow(12 * k * Math.PI, 1 / 3);
            for (var i = 0; i < 10; ++i) { // Solve for theta numerically.
              t0 = t1;
              t1 = (Math.sin(t0) - t0 * Math.cos(t0) + 2 * k * Math.PI) / (1 - Math.cos(t0));
            }
            k = (1 - Math.cos(t1 / 2)) / 2;
          }
          return k;
        }

        function bias(alpha) {
            return function(d) {
                d.x += d.bias * alpha;
            };
        }

        // function collide(node) {
        //     var r = node.radius + 16,
        //         nx1 = node.x - r,
        //         nx2 = node.x + r,
        //         ny1 = node.y - r,
        //         ny2 = node.y + r;
        //     return function(quad, x1, y1, x2, y2) {
        //         if (quad.point && (quad.point !== node)) {
        //             var x = node.x - quad.point.x,
        //                 y = node.y - quad.point.y,
        //                 l = Math.sqrt(x * x + y * y),
        //                 r = node.radius + quad.point.radius;
        //             if (l < r) {
        //                 l = (l - r) / l * .5;
        //                 node.x -= x *= l;
        //                 node.y -= y *= l;
        //                 quad.point.x += x;
        //                 quad.point.y += y;
        //             }
        //         }
        //         return x1 > nx2 || x2 < nx1 || y1 > ny2 || y2 < ny1;
        //     };
        // }

        // Resolve collisions between nodes.
        function collide(alpha) {
            var q = d3.geom.quadtree(data);
            return function(d) {
                var r = d.radius + settings.maxRadius + settings.collisionPadding,
                    nx1 = d.x - r,
                    nx2 = d.x + r,
                    ny1 = d.y - r,
                    ny2 = d.y + r;
                q.visit(function(quad, x1, y1, x2, y2) {
                    // if (quad.point && (quad.point !== d) && d.other !== quad.point && d !== quad.point.other) {
                    //     var x = d.x - quad.point.x,
                    //         y = d.y - quad.point.y,
                    //         l = Math.sqrt(x * x + y * y),
                    //         r = d.radius + quad.point.r + settings.collisionPadding;
                    //     if (l < r) {
                    //         l = (l - r) / l * alpha;
                    //         d.x -= x *= l;
                    //         d.y -= y *= l;
                    //         quad.point.x += x;
                    //         quad.point.y += y;
                    //     }
                    // }
                    if (quad.point && (quad.point !== d)) {
                        var x = d.x - quad.point.x,
                            y = d.y - quad.point.y,
                            l = Math.sqrt(x * x + y * y),
                            r = d.radius + quad.point.radius;
                        if (l < r) {
                            l = (l - r) / l * .5;
                            d.x -= x *= l;
                            d.y -= y *= l;
                            quad.point.x += x;
                            quad.point.y += y;
                        }
                    }
                    return x1 > nx2 || x2 < nx1 || y1 > ny2 || y2 < ny1;
                });
            };
        }

    </script>

</body>
</html>
